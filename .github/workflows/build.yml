name: Build Reconal

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # macOS build removed as per user request (managed manually)

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install System Dependencies
        # PyWebView on Linux requires GTK and WebKit
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev

      - name: Build Linux App
        run: |
          chmod +x scripts/build_linux.sh
          ./scripts/build_linux.sh

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: Reconal-Linux-Binary
          path: dist/Reconal_Linux

      - name: Release target
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/Reconal_Linux

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          # We use pyproject.toml now, but setup-python usually looks for requirements.txt or poetry.lock
          # We can rely on pip install . caching packages.
          # For simplicity with setup-python cache, we can skip explicit cache-dependency-path 
          # OR create a temporary requirements.txt via pip freeze if needed, but let's just cache 'pip' generically.
          # Or point to pyproject.toml if supported (experimental/specific tools needed).
          # Let's simple use 'pip' cache.

      - name: Install Dependencies
        run: |
          pip install .
          # Pillow is technically in pyproject.toml now, but ensuring it's installed for the icon script below:
          pip install Pillow

      - name: Convert Icon
        shell: python
        run: |
          from PIL import Image
          import os
          icon_path = 'src/reconal/gui/assets/logo.png'
          if os.path.exists(icon_path):
            img = Image.open(icon_path)
            img.save('Reconal.ico', format='ICO', sizes=[(256, 256), (128, 128), (64, 64), (48, 48), (32, 32), (16, 16)])
          else:
            print(f"Warning: {icon_path} not found")

      - name: Build Windows Exe
        shell: bash
        # Source: src/reconal/gui -> Destination: gui
        run: |
           pyinstaller --noconsole --onefile --windowed --name "Reconal" --icon "Reconal.ico" --add-data "src/reconal/gui;gui" src/reconal/app.py

      - name: Upload Exe
        uses: actions/upload-artifact@v4
        with:
          name: Reconal-Windows-Exe
          path: dist/Reconal.exe

      - name: Release target
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/Reconal.exe
